Select 
a.age, 
avg(a.income*b.buy_flag)-avg(a.income)*avg(b.buy_flag) as corr
from 
a join b 
on
a.phone=b.phone 
where 
a.income<=b.price 
group by a.age